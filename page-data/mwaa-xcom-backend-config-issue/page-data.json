{"componentChunkName":"component---src-templates-post-jsx","path":"/mwaa-xcom-backend-config-issue/","result":{"data":{"site":{"siteMetadata":{"title":"dev0wner's Engineering Blog"}},"markdownRemark":{"id":"4c1ab40d-5821-5c2b-aff0-eb6e84d6617b","excerpt":"문제 AWS MWAA 에 custom xcom backend를 등록하기 위해  적용 시\n클러스터 업데이트 실패 해결 1. airflow.cfg 옵션 변경 실패에 대한 디버깅 이슈 재현 local에 mwaa 환경 구축 후  적용시 클러스터 상태 확인   확인 MWAA에서는 Config 실패로 인한 retry 등으로 API Timeout이 날 때 까지 오랜 …","html":"<h2>문제</h2>\n<ul>\n<li>AWS MWAA <code class=\"language-text\">airflow.cfg</code>에 custom xcom backend를 등록하기 위해 <code class=\"language-text\">core.xcom_backend:include.s3_xcom_backend.S3XComBackend</code> 적용 시\n클러스터 업데이트 실패</li>\n</ul>\n<h2>해결</h2>\n<h3>1. airflow.cfg 옵션 변경 실패에 대한 디버깅</h3>\n<ol>\n<li>\n<p>이슈 재현</p>\n<ul>\n<li>\n<p>local에 mwaa 환경 구축 후 <code class=\"language-text\">core.xcom_backend:include.s3_xcom_backend.S3XComBackend</code> 적용시 클러스터 상태 확인</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/91773868639b32eddb0544cd10f8efe6/cc39a/2022-11-25-1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 11.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAYklEQVR42jWOSwoAIQxDZdyI3xkR//e/ZsYUXIS8tIFW5TERSoE2Bo/WcM7Bey8KISDGKEy/zDlFZt9aKzuyenvHtxZczlLIx+ecaK2h1ooxhuR+esycUzfvvVHOQyklOfIDkqYvwPRIONAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='2022 11 25 1' title='2022 11 25 1' src='/static/91773868639b32eddb0544cd10f8efe6/ca1dc/2022-11-25-1.png' srcset='/static/91773868639b32eddb0544cd10f8efe6/e7570/2022-11-25-1.png 170w,\n/static/91773868639b32eddb0544cd10f8efe6/f46e7/2022-11-25-1.png 340w,\n/static/91773868639b32eddb0544cd10f8efe6/ca1dc/2022-11-25-1.png 680w,\n/static/91773868639b32eddb0544cd10f8efe6/02d09/2022-11-25-1.png 1020w,\n/static/91773868639b32eddb0544cd10f8efe6/9d567/2022-11-25-1.png 1360w,\n/static/91773868639b32eddb0544cd10f8efe6/cc39a/2022-11-25-1.png 1694w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n</li>\n<li><code class=\"language-text\">AirflowConfigException: The object could not be loaded</code> 확인</li>\n<li>MWAA에서는 Config 실패로 인한 retry 등으로 API Timeout이 날 때 까지 오랜 시간 Cluster 상태가 <code class=\"language-text\">Updating</code>일 수 있습니다.</li>\n</ul>\n</li>\n<li>\n<p>기본 값 적용시 내용 확인</p>\n<ul>\n<li>\n<p><code class=\"language-text\">\"core.xcom_backend\": \"airflow.models.xcom.BaseXCom\"</code></p>\n<p>→ 성공</p>\n<p>→ Value값에 참조할 수 없는 값이 들어가면 실패하는 것을 유추할 수 있습니다</p>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">dags/</code> 폴더에 <code class=\"language-text\">s3_xcom_backend.py</code> 파일 생성 후 configuration 적용</p>\n<ul>\n<li><code class=\"language-text\">\"core.xcom_backend\": \"s3_xcom_backend.S3XComBackend\"</code></li>\n</ul>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/da1565b98e649d621da24c378012c31d/2561a/2022-11-25-2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 14.705882352941178%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAd0lEQVR42l2NSQ7EIAwE+f8zcaSQUVgOEHZ6cDKHIZbqYpe7BdEGRhJBSsLxORFTRkppIeeMXJ59fN3+EfuuoNQBYy289wjXNZ/LE/CjlIIQAoyxiDGitYZa6yxYPUawxLDAM8ZA732Bdxyktb5dO8udc3fw2/0Cy+LonauzsgUAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='2022 11 25 2' title='2022 11 25 2' src='/static/da1565b98e649d621da24c378012c31d/ca1dc/2022-11-25-2.png' srcset='/static/da1565b98e649d621da24c378012c31d/e7570/2022-11-25-2.png 170w,\n/static/da1565b98e649d621da24c378012c31d/f46e7/2022-11-25-2.png 340w,\n/static/da1565b98e649d621da24c378012c31d/ca1dc/2022-11-25-2.png 680w,\n/static/da1565b98e649d621da24c378012c31d/02d09/2022-11-25-2.png 1020w,\n/static/da1565b98e649d621da24c378012c31d/2561a/2022-11-25-2.png 1180w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>→ <strong>성공</strong></p>\n</li>\n</ol>\n<h3>2. MWAA Managed Node 접근 방법이 있을까?</h3>\n<ul>\n<li>Managed service이고 내부적으로 <code class=\"language-text\">Amazon ECS on Fargate</code>로 동작하기 때문에 airflow가 설치된 host의 shell로 접근할 수 있는 방법은 현재 존재하지 않습니다.</li>\n<li>\n<p>MWAA Architecture</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/40f9830c01782fdc7a0a6c676e49bb3c/adb12/2022-11-25-3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 57.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACZ0lEQVR42o1TW0/UQBTe3+lvMD7xjCQkGh/0TaPRGIwRgi9AImI0IhgQNgoE3AvZbunulr223d5me5tpP89MFx+MJjY5yWnnnDPnu7RiOS6mXoCJM8VVr4+x7ah8MLZU7voB/vcpigKV80YTtUsNumHioqGhpXfRandQv2yr0DsmeJYh5znSJEYSR+BpRsEhuECeccSdEQSL1dDKqXEIn3mU5jf3/HkvMpGq7GfvBLplzr8L8DxDFidoLr1EWDPKgbI0aFXRe30bg637sHefIC/K8aMvKxhu3oUfzWA7KVhE2/VP0KjbeL5qYZZwNURuKzdVA2VjbF3DPdvBsLqN7vE24kyow+DqAn59D24YYKxPELoBXO0bDg4MLD9swgsiFCwkOgSKvERYEZQk4RSOVv0NMgtsWLVdWO0TRMNLIlvg+tEDzGrnJQl5uU3ikZDLS+CmORclR0UmXvMQ7ce3kAYTSAo87Qc6r+6gu76I4cYibN9F66gBZzKFNTQxWFuA3TqCQxten2lwRhY4n0OO4wwiTZF6DkIq8NkMgRuCswAiZmC2D8dhCGcCEXFljYfQ3j3FSL8Ao/cwzMFYBEFOUAPHI4ZUCMRxDneSKrUtK0ZEPKYU/X6MqRMq7TlBElQrdxHkOcGz0h2kYiHmHBrPNsG+1tH1DLx4f4+OC5grO5h+OqWGEP03C8o6g7V12JsbqiknRDlBlGLcRCGHyoH65yoJYMAY97Cx/xYsS9D6eAzze4NgBqh9WIVHSl7t7aNzcFi6tSj+4tb5n3LzkhEfsjojLiTwVBqabk7kGXlMwuRK4Vw1/it+ARIjhsZ+t3OJAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='2022 11 25 3' title='2022 11 25 3' src='/static/40f9830c01782fdc7a0a6c676e49bb3c/ca1dc/2022-11-25-3.png' srcset='/static/40f9830c01782fdc7a0a6c676e49bb3c/e7570/2022-11-25-3.png 170w,\n/static/40f9830c01782fdc7a0a6c676e49bb3c/f46e7/2022-11-25-3.png 340w,\n/static/40f9830c01782fdc7a0a6c676e49bb3c/ca1dc/2022-11-25-3.png 680w,\n/static/40f9830c01782fdc7a0a6c676e49bb3c/adb12/2022-11-25-3.png 970w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n</li>\n</ul>\n<h3>3. Airflow Configuration 변경 방법</h3>\n<ul>\n<li>현재 MWAA에서는 airflow.cfg를 <strong>직접적</strong>으로 변경할 수 있는 방법을 제공하지 않습니다.</li>\n<li>\n<p>가능한 방법은 아래 3가지 입니다.</p>\n<ol>\n<li>\n<p><code class=\"language-text\">CFN</code>이나 <code class=\"language-text\">CDK</code>등 <code class=\"language-text\">IaC</code>를 사용하여 생성하거나 업데이트 할 때 옵션 반영</p>\n<ul>\n<li><code class=\"language-text\">AirflowConfigurationOptions</code></li>\n</ul>\n</li>\n<li>WEB UI를 통한 방법</li>\n</ol>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/3da0fafcf2733f560f8cc20d16daa2c4/18baa/2022-11-25-4.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 32.35294117647059%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1klEQVR42oWP4Q6CMAyEef/XU8AoGvCPwDYYxA0Hg7NdRI2JuuTLuqa9u0XGGGy2MY7HE+I4QZKk2B8ypOkORXFGlmU45QWUvmIYBljL2EdtYekeHkzeI+Jmnp9xKUsIKVFVNaRSEEKGN6NUA617NE2LttVPeE7rLvT7vodnwWmagqtzDjdiHEc4gvvcW9O40WFZlq/42b8EFTmUlCxQ1qhqEWrddcGMBdno12HReZ4R8SAvCqlIuEFNX5X0RUlvY2wYWoc5wTc4WEi4Lqwu7+efyCe8fwdroM/7uFSrBgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='2022 11 25 4' title='2022 11 25 4' src='/static/3da0fafcf2733f560f8cc20d16daa2c4/ca1dc/2022-11-25-4.png' srcset='/static/3da0fafcf2733f560f8cc20d16daa2c4/e7570/2022-11-25-4.png 170w,\n/static/3da0fafcf2733f560f8cc20d16daa2c4/f46e7/2022-11-25-4.png 340w,\n/static/3da0fafcf2733f560f8cc20d16daa2c4/ca1dc/2022-11-25-4.png 680w,\n/static/3da0fafcf2733f560f8cc20d16daa2c4/18baa/2022-11-25-4.png 785w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<ol start=\"3\">\n<li>AWS-CLI를 통한 방법</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token comment\"># update configuration</span>\naws mwaa update-environment <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--name</span> xcom_backend_test <span class=\"token punctuation\">\\</span>\n--airflow-configuration-options <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">\\</span>\"scheduler.dag_dir_list_interval<span class=\"token punctuation\">\\</span>\": <span class=\"token punctuation\">\\</span>\"5<span class=\"token punctuation\">\\</span>\",\n  <span class=\"token punctuation\">\\</span>\"scheduler.min_file_process_interval<span class=\"token punctuation\">\\</span>\": <span class=\"token punctuation\">\\</span>\"5<span class=\"token punctuation\">\\</span>\",\n  <span class=\"token punctuation\">\\</span>\"webserver.expose_config<span class=\"token punctuation\">\\</span>\": <span class=\"token punctuation\">\\</span>\"True<span class=\"token punctuation\">\\</span>\"\n  <span class=\"token punctuation\">}</span><span class=\"token string\">\"\"</span>\"</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token comment\"># check configuration</span>\naws mwaa get-environment <span class=\"token punctuation\">\\</span>\n<span class=\"token parameter variable\">--name</span> xcom_backend_test <span class=\"token operator\">|</span> <span class=\"token punctuation\">\\</span>\njq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">'.Environment.AirflowConfigurationOptions'</span></code></pre></div>\n</li>\n</ul>\n<h3>4. AWS-MWAA-LOCAL-RUNNER</h3>\n<ul>\n<li>\n<p>MWAA 환경에 직접적인 접근은 어렵지만, <a href=\"https://github.com/aws/aws-mwaa-local-runner\">aws-mwaa-local-runner</a>를 통해 local에 MWAA를\nmocking하여 테스트를 할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>. /aws-mwaa-local-runner/docker/config/airflow.cfg 변경\n<span class=\"token number\">2</span>. ./mwaa-local-env build-image\n<span class=\"token number\">3</span>. ./mwaa-local-env start\n<span class=\"token number\">4</span>. airflow.cfg 반영 확인</code></pre></div>\n</li>\n</ul>\n<h3>5. 현재 MWAA에 적용된 airflow.cfg 값 및 환경변수 확인 방법</h3>\n<ul>\n<li>여기에는 몇가지 방법이 있을 수 있습니다.</li>\n<li>환경변수에서 확인</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> __future__ <span class=\"token keyword\">import</span> annotations\n\n<span class=\"token keyword\">import</span> logging\n<span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">from</span> datetime <span class=\"token keyword\">import</span> datetime<span class=\"token punctuation\">,</span> timedelta\n\n<span class=\"token keyword\">from</span> airflow <span class=\"token keyword\">import</span> DAG\n<span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>operators<span class=\"token punctuation\">.</span>python <span class=\"token keyword\">import</span> PythonOperator\n\nlogger <span class=\"token operator\">=</span> logging<span class=\"token punctuation\">.</span>getLogger<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">with</span> DAG<span class=\"token punctuation\">(</span>\n<span class=\"token string\">'get_env_var'</span><span class=\"token punctuation\">,</span>\ndefault_args<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'depends_on_past'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'retries'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'retry_delay'</span><span class=\"token punctuation\">:</span> timedelta<span class=\"token punctuation\">(</span>minutes<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  description<span class=\"token operator\">=</span><span class=\"token string\">'check mwaa configuration'</span><span class=\"token punctuation\">,</span>\n  start_date<span class=\"token operator\">=</span>datetime<span class=\"token punctuation\">(</span><span class=\"token number\">2022</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  catchup<span class=\"token operator\">=</span><span class=\"token boolean\">False</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> dag<span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">def</span> <span class=\"token function\">print_env_vars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  keys <span class=\"token operator\">=</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> keys<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>k<span class=\"token punctuation\">}</span></span><span class=\"token string\">: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>v<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span>\n\nget_env_vars_operator <span class=\"token operator\">=</span> PythonOperator<span class=\"token punctuation\">(</span>\ntask_id<span class=\"token operator\">=</span><span class=\"token string\">'get_env_vars_task'</span><span class=\"token punctuation\">,</span>\npython_callable<span class=\"token operator\">=</span>print_env_vars\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ol start=\"2\">\n<li>airflow.cfg 파일에서 확인</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> __future__ <span class=\"token keyword\">import</span> annotations\n\n<span class=\"token keyword\">import</span> logging\n<span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">from</span> datetime <span class=\"token keyword\">import</span> datetime<span class=\"token punctuation\">,</span> timedelta\n\n<span class=\"token keyword\">from</span> airflow <span class=\"token keyword\">import</span> DAG\n<span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>operators<span class=\"token punctuation\">.</span>python <span class=\"token keyword\">import</span> PythonOperator\n\nlogger <span class=\"token operator\">=</span> logging<span class=\"token punctuation\">.</span>getLogger<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">with</span> DAG<span class=\"token punctuation\">(</span>\n<span class=\"token string\">'get_airflow_cfg_file'</span><span class=\"token punctuation\">,</span>\ndefault_args<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'depends_on_past'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'retries'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'retry_delay'</span><span class=\"token punctuation\">:</span> timedelta<span class=\"token punctuation\">(</span>minutes<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  description<span class=\"token operator\">=</span><span class=\"token string\">'check mwaa configuration'</span><span class=\"token punctuation\">,</span>\n  start_date<span class=\"token operator\">=</span>datetime<span class=\"token punctuation\">(</span><span class=\"token number\">2022</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  catchup<span class=\"token operator\">=</span><span class=\"token boolean\">False</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> dag<span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">def</span> <span class=\"token function\">print_airflow_cfg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">'AIRFLOW_HOME'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">/airflow.cfg\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'r'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> airflow_cfg<span class=\"token punctuation\">:</span>\n  file_contents <span class=\"token operator\">=</span> airflow_cfg<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'\\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>file_contents<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span>\n\nget_airflow_cfg_operator <span class=\"token operator\">=</span> PythonOperator<span class=\"token punctuation\">(</span>\ntask_id<span class=\"token operator\">=</span><span class=\"token string\">'get_airflow_cfg_task'</span><span class=\"token punctuation\">,</span>\npython_callable<span class=\"token operator\">=</span>print_airflow_cfg\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ol start=\"3\">\n<li>airflow.configuration.conf 확인</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> __future__ <span class=\"token keyword\">import</span> annotations\n\n<span class=\"token keyword\">import</span> logging\n<span class=\"token keyword\">from</span> datetime <span class=\"token keyword\">import</span> datetime<span class=\"token punctuation\">,</span> timedelta\n\n<span class=\"token keyword\">from</span> airflow <span class=\"token keyword\">import</span> DAG\n<span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>configuration <span class=\"token keyword\">import</span> conf\n<span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>operators<span class=\"token punctuation\">.</span>python <span class=\"token keyword\">import</span> PythonOperator\n\nlogger <span class=\"token operator\">=</span> logging<span class=\"token punctuation\">.</span>getLogger<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">with</span> DAG<span class=\"token punctuation\">(</span>\n<span class=\"token string\">'get_airflow_cfg'</span><span class=\"token punctuation\">,</span>\ndefault_args<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'depends_on_past'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'retries'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'retry_delay'</span><span class=\"token punctuation\">:</span> timedelta<span class=\"token punctuation\">(</span>minutes<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  description<span class=\"token operator\">=</span><span class=\"token string\">'check mwaa configuration'</span><span class=\"token punctuation\">,</span>\n  start_date<span class=\"token operator\">=</span>datetime<span class=\"token punctuation\">(</span><span class=\"token number\">2022</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  catchup<span class=\"token operator\">=</span><span class=\"token boolean\">False</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> dag<span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">def</span> <span class=\"token function\">get_conf_vars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  logging<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span>\n  <span class=\"token string-interpolation\"><span class=\"token string\">f\"AIRFLOW__CORE__XCOM_BACKEND: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>conf<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>section<span class=\"token operator\">=</span><span class=\"token string\">'CORE'</span><span class=\"token punctuation\">,</span> key<span class=\"token operator\">=</span><span class=\"token string\">'XCOM_BACKEND'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n  <span class=\"token punctuation\">)</span>\n\nget_conf_vars_operator <span class=\"token operator\">=</span> PythonOperator<span class=\"token punctuation\">(</span>\ntask_id<span class=\"token operator\">=</span><span class=\"token string\">'get_conf_vars_task'</span><span class=\"token punctuation\">,</span>\npython_callable<span class=\"token operator\">=</span>get_conf_vars\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ol start=\"4\">\n<li>MWAA Web UI에서 확인</li>\n<li>진행 과정 요약</li>\n<li>\"webserver.expose_config\": \"True” 값을 먼저 설정합니다.</li>\n</ol>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/6fd48288d918c49f49551ce87f38762f/98b00/2022-11-25-5.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 21.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAk0lEQVR42o3MwQ6CMBAE0P7/p3kyeiCaCEEsUARKItDutmWsjXfY5GU2cxihlEJVVSjLJ6SUqJsG82LATCA6xloLY0z6hZ4mtKpDPwxY/yUxg13E+5xzmOcFo57SsNCjhmoV+u6dUCwRNmzeR2FfCHBxOMT8ndCnK4bLDf05wyfLQY8XXFEfk0v4mOu9hM0KeGJ8AW/gM4uRJIJSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='2022 11 25 5' title='2022 11 25 5' src='/static/6fd48288d918c49f49551ce87f38762f/ca1dc/2022-11-25-5.png' srcset='/static/6fd48288d918c49f49551ce87f38762f/e7570/2022-11-25-5.png 170w,\n/static/6fd48288d918c49f49551ce87f38762f/f46e7/2022-11-25-5.png 340w,\n/static/6fd48288d918c49f49551ce87f38762f/ca1dc/2022-11-25-5.png 680w,\n/static/6fd48288d918c49f49551ce87f38762f/02d09/2022-11-25-5.png 1020w,\n/static/6fd48288d918c49f49551ce87f38762f/98b00/2022-11-25-5.png 1202w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<ul>\n<li>MWAA Web UI → Admin → Configuration에 들어갑니다.</li>\n</ul>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 612px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/1de3a02c5849803d3512998d399ab815/dbf98/2022-11-25-6.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 31.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABPUlEQVR42jVRy07DMBDM/38IEhIXJLhw4QIHECCkSoBCKwKlaeMmtuM6qd/D2hWWNh7v7own6+r7q8X96zP4OGLSGiFGMMZgrcVIuWEYkFKClBKc84IF7SOdg/fgVPfOI69cq7ZywlvX4DjPMMYgkqAQouAsmAnBh5N43yMg4XCcMVtDCBj1gXJAJLEQAio9k3qIxdFMokop2id4uj2LpxThnCuikYi2F+CLGs3DC1TdILY9zGoNozR8FnxaWehpwkTBWIe6rrFcLknQFZf/YSnycu8N1hc3WJxfYXF2ie72Eer6Dp7xUq9iDEQO5WBddpUKPhoHl10Vl6n0eMLeWIifDX4/PiHWLYJQCKMuc8y/XUk1YbsXhbzrJdqOE/boqXFH+T0nAo0k97CBZkpkeaAaPZxPp8vzN+t0xP8Dcy7Lfc+jU/wAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='2022 11 25 6' title='2022 11 25 6' src='/static/1de3a02c5849803d3512998d399ab815/dbf98/2022-11-25-6.png' srcset='/static/1de3a02c5849803d3512998d399ab815/e7570/2022-11-25-6.png 170w,\n/static/1de3a02c5849803d3512998d399ab815/f46e7/2022-11-25-6.png 340w,\n/static/1de3a02c5849803d3512998d399ab815/dbf98/2022-11-25-6.png 612w' sizes='(max-width: 612px) 100vw, 612px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<ul>\n<li>UI에서 airflow.cfg를 확인합니다</li>\n</ul>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/0f4446c8f80891195e7f14d6a90524d8/1745e/2022-11-25-7.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 103.52941176470587%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAACq0lEQVR42oVUi3LaMBD0//9c27RpYsC2LFl+ghNcwjtcd68SwzBDysyObKNb7e6dnTy9pGK6Vg67vXx8fMg0TbJer+X9/V32+72Mq1FOp5O8vb3J8XiUaT3J5XKRR79k3G5ls9/KGUUsPJ/PitPpqAQ8hOsW+w6Hg+x2O933CEmRLSTLMqmqStc0TWWxWEie51rMX1R0uz5CMgyD1HUtfd/LcrlUYu+9tG2r9qmMKjebja7/gxKymKRcu667omma6zNmSIzj+CWS1Wql6kjMa668j4RUy7XDMxLGhj1C0g+99CgeUEAiyr58fmqT2JzPa5NOev1VQ7QpaTmXmSnEwXIJNRUsehArcFB9B6qgykdIrC9lbuZiKyfOGDHodIEum/lcDO4tDnKwzMN4zViY1QqIud4isbWXzJYoqCQvrWQktVa7zdw6ZoruR7R4RlAtyaeQKck0Q992YnA6YRvYDoqoRi0jgjYQNzdk3NOHZ/wvNivJnJPnLJfUlPJaGJlD3QtUpgBtGiglecH5BDlVkuCqPKxLqFXLvnFiXC4FYJwRX8L+IhMHcirxQWEVyKLl/k4x9+kclh65lbnktpBFiW5DSQGVzJEKqcyEhrCYStQ+57TrtTlT6LBarttKqtpibEoMcSUtsmlQMAQ7LI6KYmOGAF6TMDYldLmVH7O5/ITNnxiZDIpy4Bs+Et+BGSL4jYyf8f8vjFMfDogR3JKpQgd1mYVlbM5AUOErUzFHX6vVCooJF7ofZ5DW72fxH2GDOXQWM1hqbsyvQjEVMHRmpyOEe9pkXhG3b0hUmnBUnvBWqMXZTG1zdF6LQl6gNiINb02cQR5A2HD4AMVBIWfMSe7YGC8lMwwdjq9bLF7d2g1YBozRctfDkjcK31hpQVIDlP8HH9jpztZXYM1fPVoncqi9rWEAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='2022 11 25 7' title='2022 11 25 7' src='/static/0f4446c8f80891195e7f14d6a90524d8/ca1dc/2022-11-25-7.png' srcset='/static/0f4446c8f80891195e7f14d6a90524d8/e7570/2022-11-25-7.png 170w,\n/static/0f4446c8f80891195e7f14d6a90524d8/f46e7/2022-11-25-7.png 340w,\n/static/0f4446c8f80891195e7f14d6a90524d8/ca1dc/2022-11-25-7.png 680w,\n/static/0f4446c8f80891195e7f14d6a90524d8/1745e/2022-11-25-7.png 814w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<h2>Summary</h2>\n<ul>\n<li>\n<p>MWAA의 세팅 관련 참고할만한 자료입니다.</p>\n<ul>\n<li><a href=\"https://catalog.workshops.aws/amazon-mwaa-for-analytics/en-US\">https://catalog.workshops.aws/amazon-mwaa-for-analytics/en-US</a></li>\n<li><a href=\"https://catalog.workshops.aws/aws-data-ingestion-pipeline/ko-KR\">https://catalog.workshops.aws/aws-data-ingestion-pipeline/ko-KR</a></li>\n</ul>\n</li>\n<li>xcom_backend의 값으로 <strong>참조 가능한 경로에 파일이 있어야만</strong> 클러스터 정상 업데이트 가능합니다.</li>\n<li>airflow.cfg 값을 호스트에 접근하여 직접적으로 변경할 수 있는 방법은 없습니다.</li>\n<li>MWAA는 Managed service이기 때문에, 위에 설명드린 방법으로 우회하여 구조 등을 확인하실 수 있습니다.</li>\n<li>\n<p>현재 MWAA에서는 만약 <code class=\"language-text\">잘못된 세팅값</code>으로 클러스터를 업데이트 시키면, 내부 요인에 의해 장시간 클러스터pending 상태가 될 수 있습니다. 이를 대비하는 방법은 아래와 같습니다.</p>\n<ul>\n<li>aws-mwaa-local-runner로 미리 구성을 확인합니다.</li>\n<li>Network or Permission 문제일 수도 있기 때문에 <a href=\"https://github.com/awslabs/aws-support-tools/tree/master/MWAA\">링크와</a> 같은 도구를\n이용하는 것을 추천 드립니다.</li>\n<li>MWAA <code class=\"language-text\">23년 마일스톤</code>으로 클러스터 업데이트 구성 지연 이슈는 해결될 예정입니다.</li>\n</ul>\n</li>\n</ul>\n<h2>References</h2>\n<ul>\n<li><a href=\"https://programmaticponderings.com/2020/12/29/amazon-managed-workflows-for-apache-airflow-configuration-understanding-amazon-mwaas-configuration-options/\">https://programmaticponderings.com/2020/12/29/amazon-managed-workflows-for-apache-airflow-configuration-understanding-amazon-mwaas-configuration-options/</a></li>\n<li><a href=\"https://airflow.apache.org/docs/apache-airflow/2.2.2/configurations-ref.html\">https://airflow.apache.org/docs/apache-airflow/2.2.2/configurations-ref.html</a></li>\n<li><a href=\"https://docs.aws.amazon.com/mwaa/latest/userguide/configuring-env-variables.html#configuring-env-variables-airflow-ref\">https://docs.aws.amazon.com/mwaa/latest/userguide/configuring-env-variables.html#configuring-env-variables-airflow-ref</a></li>\n<li><a href=\"https://docs.astronomer.io/learn/custom-xcom-backends\">https://docs.astronomer.io/learn/custom-xcom-backends</a></li>\n<li><a href=\"https://docs.aws.amazon.com/mwaa/latest/userguide/what-is-mwaa.html\">https://docs.aws.amazon.com/mwaa/latest/userguide/what-is-mwaa.html</a></li>\n</ul>","frontmatter":{"title":"AWS MWAA xcom backend configuration 이슈 해결","date":"November 25, 2022","update":"November 25, 2022","tags":["AWS","MWAA","Airflow"],"series":null},"fields":{"slug":"/mwaa-xcom-backend-config-issue/","readingTime":{"minutes":5.115}}},"seriesList":{"edges":[{"node":{"id":"67aef85d-aa61-544e-bd62-5209f824cecc","fields":{"slug":"/socar-data-meetup/"},"frontmatter":{"title":"2022 Socar Data Meetup"}}},{"node":{"id":"c721f526-5c44-52ff-ba22-40f2208abdc8","fields":{"slug":"/programmers-data-engineering-conference/"},"frontmatter":{"title":"2022 실리콘밸리에서 날아온 데이터 엔지니어링 컨퍼런스"}}},{"node":{"id":"c5f6f476-1722-587a-a605-fabb26510c02","fields":{"slug":"/aws-kafka-on-eks-vs-msk/"},"frontmatter":{"title":"Kafka on EKS vs MSK"}}},{"node":{"id":"4c1ab40d-5821-5c2b-aff0-eb6e84d6617b","fields":{"slug":"/mwaa-xcom-backend-config-issue/"},"frontmatter":{"title":"AWS MWAA xcom backend configuration 이슈 해결"}}}]},"previous":{"fields":{"slug":"/aws-kafka-on-eks-vs-msk/"},"frontmatter":{"title":"Kafka on EKS vs MSK"}},"next":null},"pageContext":{"id":"4c1ab40d-5821-5c2b-aff0-eb6e84d6617b","series":null,"previousPostId":"c5f6f476-1722-587a-a605-fabb26510c02","nextPostId":null}},"staticQueryHashes":[]}